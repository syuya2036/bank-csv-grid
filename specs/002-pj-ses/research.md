# Research: 複数・階層タグ付与と階層集計

## Decisions

- 集計ルール: 初期は「重複排除（主タグなし）」。一旦は同一取引に複数葉タグは付与不可。将来、按分（比率指定）を検討。
- 親子選択ルール: 葉タグ選択時に祖先は自動的に文脈として扱い、保存は葉タグ単位（祖先は冗長保存しない）。
- 階層深さ: 任意深さ対応。UI は動的カスケードにより段階的に展開。
- 名称一意: 同一親内で一意（フルパス重複は不可）。
- CSV I/O: エクスポートはフルパス（`PJ収入の部>プロジェクト売り上げ>SES`）の配列。インポート時は完全一致で解決、未解決は警告。
- 権限: タグマスタ編集は管理者のみ。一般ユーザーは付与可能。
- 期間/タイムゾーン: 取引日ベース、アプリの既定 TZ で集計。
- 監査: 付与/削除/更新を記録（誰が/いつ/何を → 何に）。保持期間は 1 年。

## Rationale

- 重複排除: 二重計上防止が最優先。按分は将来の拡張余地として残す。
- 祖先の自動扱い: データ正規化を保ち、集計で祖先へロールアップすることで一貫性確保。
- 任意深さ: 将来の拡張・柔軟性を確保。

## Alternatives Considered

- 按分（比率指定）: 柔軟だが入力負荷・運用複雑度が高い。
- 主タグ優先: シンプルだが情報損失が大きい。

## Open Questions (none)

NEEDS CLARIFICATION は本研究で初期方針を設定し、実装可能な状態に解消済み。
