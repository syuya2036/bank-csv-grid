# Feature Specification: 月次予測（KPI連動）機能

**Feature Branch**: `003-speckit-specify-n`
**Created**: 2025-10-15
**Status**: Draft
**Input**: User description: 月次集計グリッドに各月の右側へ予測列を追加し、KPIタグの手入力または計算指定により科目タグの予測値を算出する。KPIタグは取引明細には付与せず、集計画面で月単位に値を持つ。科目タグは従来どおり明細へ付与可能。KPIタグは葉であり、タグ定義画面で科目/KPIを切替、タグツリーではKPIを色分け表示。明細付与画面ではKPIを非表示。集計画面ではKPIセルは編集可、科目セル（実績）は編集不可。

## User Scenarios & Testing (mandatory)

### User Story 1 - 月次予測列でKPIを編集し予測を得る (Priority: P1)

経理/事業担当者として、月次集計画面で各月の実績列の右にある予測列を開き、KPIタグ行のセルに数値または式を入力すると、同月の科目タグ行の予測値が自動的に更新される。

**Why this priority**: 予算/見込み管理の中心となる体験で、業務価値が最も高い。

**Independent Test**: 新規/月次画面でKPIセル編集のみで、科目予測が更新されることを確認すれば単独で価値を検証可能。

**Acceptance Scenarios**:

1. **Given** 月次集計画面が開いている, **When** KPI行の予測セルに数値を入力, **Then** 同月の依存する科目行の予測セルが即時に再計算される
2. **Given** KPI行のセルに式が設定されている, **When** 参照するKPIセルの値を変更, **Then** 式の結果が再計算され科目予測に反映される

---

### User Story 2 - タグ定義でKPI/科目を切替し見やすく管理 (Priority: P1)

管理者として、タグ定義画面でタグ種別（科目/KPI）を選択し、タグツリーではKPIが色分け表示で区別でき、取引明細のタグ付与画面ではKPIが候補に出ない。

**Why this priority**: データモデリングの正しさと運用性を左右し、誤付与防止に直結するため。

**Independent Test**: 種別切替・色分け表示・明細画面でのKPI非表示を個別に検証可能。

**Acceptance Scenarios**:

1. **Given** タグ定義画面, **When** 新規タグで種別をKPIに設定, **Then** タグツリーでKPI色で表示され、明細タグ選択には出現しない
2. **Given** 既存タグを科目→KPIへ変更, **When** 保存, **Then** タグ付与対象外となり月次予測で編集対象になる

---

### User Story 3 - 実績セルは常に参照専用で誤編集を防ぐ (Priority: P2)

利用者として、科目タグ×実績列のセルは常に編集不可で、コピー/貼り付けやキーボード操作でも変更できない。

**Why this priority**: 実績の整合性を守る品質要件。

**Independent Test**: 実績セルへの編集操作が全て無効であることを単独検証可能。

**Acceptance Scenarios**:

1. **Given** 実績セルにフォーカス, **When** 入力/貼付/削除を試行, **Then** 値は変化せず操作は無効化される

---

### Edge Cases

- KPIセルが未入力（空）の場合：算術式では0として扱い、参照先の予測値はその前提で計算される。単独表示時は空として見せる。
- 循環参照：保存・再計算を拒否しエラーメッセージと参照ハイライトで通知する。
- 月に実績がない科目：予測列は表示され、KPIに基づき値を算出可能。
- 子がKPIのみの科目タグ：葉として扱い、明細付与可能（要件に従う）。
- 無効な入力（非数値/未定義参照）：エラー表示し保存不可。既存値は保持。

## Requirements (mandatory)

### Functional Requirements

- **FR-001（予測列の追加）**: 月次集計画面の各月の実績列の直右に、その月の「予測」列を表示する。
- **FR-002（セル種別と編集可否）**:
  - 科目×実績セルは参照専用（編集不可）。
  - KPI×予測セルは編集可能（数値入力/セル参照を含む式入力）。
  - KPI×実績セルは編集可能。だが、今回は特に意味を持たせない。
  - 科目×予測セルは直接編集可。値はて手入力、KPIまたは定義式により決定される。
- **FR-003（KPIの性質）**: KPIタグは必ず葉とし、取引明細には付与不可。KPI値はタグ×月で保持される。
- **FR-004（科目タグの葉判定緩和）**: 子要素がKPIのみの科目タグは葉として扱い、明細に付与可能。
- **FR-005（タグ定義UI）**: タグ定義画面でタグ種別（科目/KPI）を選択できる。タグツリーではKPIを色分け表示する。
- **FR-006（明細タグ付与UI）**: 明細へのタグ付与候補にKPIタグを表示しない。
- **FR-007（式と再計算）**: 予測セルの式は同一月内のセル参照と基本四則演算（+,-,*,/）と括弧をサポートする。参照先変更や入力時は依存セルを即時再計算する。
- **FR-008（循環参照防止）**: 循環参照は検出し、保存・適用を禁止してユーザーに場所と理由を明示する。
- **FR-009（コピー/貼付/取り消し）**: 予測セルはコピー/貼付、取り消し/やり直しをサポートする。参照・数値のいずれも操作可能。
- **FR-010（表示一貫性）**: 実績/予測の表示形式は月全体で統一され、空/エラー/計算中の状態が判別できる。
- **FR-011（データ保持）**: 予測に関わる数値・式はタグ×月の単位で保存・復元できる（ページ再読込後も失われない）。
- **FR-012（権限/監査の前提）**: 既存の閲覧/編集権限体系に従い、編集可否が制御される。編集履歴の追跡は既存の方針に準拠する。

### Key Entities (include if feature involves data)

- **Tag（タグ）**: 種別（科目/KPI）、親子関係、表示名。
- **MonthlyCell（月次セル）**: 月、タグ、列種別（実績/予測）、値、表示状態（空/値/エラー）。
- **ForecastDefinition（予測定義）**: 科目タグの予測値を決めるルール（KPI参照や算術式）。

## Constraints & Assumptions

- **TC-001（セル計算エンジン）**: セル計算にはHyperFormulaを採用する（循環検出・依存グラフ再計算・表計算互換性のため）。React-data-gridに組み込む形で実装する。
- **TC-002（置換可能性）**: 将来のエンジン置換に備え、UI層と計算エンジン間に抽象化を設ける（式評価・依存解析・再計算トリガのインターフェースを分離）。

## Success Criteria (mandatory)

### Measurable Outcomes

- **SC-001（編集体験）**: テスト利用者の90%が、KPI入力により科目予測を更新するタスクを3分以内に完了。
- **SC-002（即時性）**: KPI編集から依存セルの画面反映までの体感待ち時間が1秒未満であることが95%の操作で満たされる。
- **SC-003（誤操作防止）**: 実績セルへの編集試行がすべて無効化され、試験で100%再現。
- **SC-004（再現性/保存）**: 予測セルの入力/式は保存後・再表示後も100%復元される。
